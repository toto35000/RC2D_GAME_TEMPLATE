name: Generate Executable (staging)

on:
  push:
    branches:
      - alpha
      - beta
      - staging
  workflow_dispatch:

env:
  ANDROID_NDK_VERSION: "29.0.14206865"
  ANDROID_PLATFORM_VERSION: "android-36"
  ANDROID_BUILD_TOOLS_VERSION: "36.1.0"
  ANDROID_CMAKE_VERSION: "3.30.3"
  ANDROID_CMDLINE_TOOLS_VERSION: "20.0"
  JAVA_DISTRIBUTION: "temurin"
  JAVA_VERSION: "17"
  ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
  ANDROID_KEYSTORE_ALIAS_NAME: ${{ secrets.ANDROID_KEYSTORE_ALIAS_NAME }}
  ANDROID_KEYSTORE_KEY_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_KEY_PASSWORD }}

  XCODE_VERSION: "26.3.0"

  # TODO: A modifier pour chaque nouvelle application iOS / macOS pour : com.crzgames.*
  # Cela sert pour le CMakelists.txt
  APP_IOSMACOS_IDENTIFIER: com.crzgames.testexe
  # Cela sert pour le CMakelists.txt
  APP_COMPANY_NAME: CrzGames
  # TODO: A modifier pour chaque nouvelle application
  # Cela sert pour le CMakelists.txt
  APP_GAME_DESCRIPTION: MyGame - MMORPG
  # Cela sert pour le CMakelists.txt
  APP_LEGAL_COPYRIGHT: Copyright 2026 CrzGames
  # Cela sert pour le CMakelists.txt
  APP_IOSMACOS_DEVELOPMENT_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
  # TODO: A modifier pour chaque nouvelle application iOS pour : secrets.IOS_APPLE_PROVISIONING_PROFILE_APPLEDISTRIBUTION_TESTEXE_NAME
  # Cela sert pour le CMakelists.txt
  APP_IOS_PROVISIONING_PROFILE_NAME: ${{ secrets.IOS_APPLE_PROVISIONING_PROFILE_APPLEDISTRIBUTION_TESTEXE_NAME }}
  # TODO: A modifier pour chaque nouvelle application iOS pour : secrets.IOS_APPLE_PROVISIONING_PROFILE_APPLEDISTRIBUTION_TESTEXE_UUID
  # Cela sert pour le CMakelists.txt
  APP_IOS_PROVISIONING_PROFILE_UUID: ${{ secrets.IOS_APPLE_PROVISIONING_PROFILE_APPLEDISTRIBUTION_TESTEXE_UUID }}
  # Cela sert pour le CMakelists.txt
  APP_IOS_CODE_SIGN_IDENTITY: "Apple Distribution: Corentin Recanzone (2X96T6AM4K)"
  # Cela sert pour le CMakelists.txt
  APP_MACOS_CODE_SIGN_IDENTITY: "Developer ID Application: Corentin Recanzone (2X96T6AM4K)"
  # Cela sert pour le CMakelists.txt
  APP_VERSION: 1.0.0 # Valeur par défaut, sera écrasé par la valeur lue dans version.txt

  ###### IOS ######
  # Certificat Apple au format p12 encodé en base64 
  IOSMACOS_APPLE_CERTIFICATE_APPLEDISTRIBUTION_P12_BASE64: ${{ secrets.IOSMACOS_APPLE_CERTIFICATE_APPLEDISTRIBUTION_P12_BASE64 }}
  # Mot de passe du certificat p12
  IOSMACOS_APPLE_CERTIFICATE_APPLEDISTRIBUTION_P12_PASSWORD: ${{ secrets.IOSMACOS_APPLE_CERTIFICATE_APPLEDISTRIBUTION_P12_PASSWORD }}
  # Profil de provisionnement Apple au format : .mobileprovision (iOS) ou .provisionprofile (macOS) encodé en base64
  # TODO: A modifier pour chaque nouvelle application iOS pour : secrets.IOS_APPLE_PROVISIONING_PROFILE_APPLEDISTRIBUTION_TESTEXE_BASE64
  IOSMACOS_APPLE_PROVISIONING_PROFILE_APPLEDISTRIBUTION_BASE64: ${{ secrets.IOS_APPLE_PROVISIONING_PROFILE_APPLEDISTRIBUTION_TESTEXE_BASE64 }}
  # Mot de passe spécifique à l'application pour l'identifiant Apple, nécessaire pour l'upload sur App Store Connect via altool ou Fastlane
  APPLE_APPLICATION_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APPLICATION_SPECIFIC_PASSWORD }}
  # Variables pour l'API App Store Connect, nécessaires pour l'upload sur App Store Connect via Fastlane (recommandé)
  APPLE_APPSTORECONNECT_API_KEY_ID: ${{ secrets.APPLE_APPSTORECONNECT_API_KEY_ID }}
  APPLE_APPSTORECONNECT_API_ISSUER_ID: ${{ secrets.APPLE_APPSTORECONNECT_API_ISSUER_ID }}
  APPLE_APPSTORECONNECT_API_KEY_P8_BASE64: ${{ secrets.APPLE_APPSTORECONNECT_API_KEY_P8_BASE64 }}
  
  ###### iOS / macOS - Commun ######
  # Un nouveau trousseau sera créé sur le coureur, de sorte que le mot de passe du nouveau trousseau peut être n'importe quelle nouvelle chaîne aléatoire
  KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
  # Identifiant (Email) du compte développeur Apple
  APPLE_ID: ${{ secrets.APPLE_ID }}
  # Identifiant de l'équipe Apple (Team ID) associé au compte développeur Apple, nécessaire pour l'upload sur App Store Connect via altool ou Fastlane
  APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}

  ###### macOS ######
  # Certificat Apple au format p12 encodé en base64
  MACOS_APPLE_CERTIFICATE_DEVELOPERIDAPPLICATION_P12_BASE64: ${{ secrets.MACOS_APPLE_CERTIFICATE_DEVELOPERIDAPPLICATION_P12_BASE64 }}
  # Mot de passe du certificat p12
  MACOS_APPLE_CERTIFICATE_DEVELOPERIDAPPLICATION_P12_PASSWORD: ${{ secrets.MACOS_APPLE_CERTIFICATE_DEVELOPERIDAPPLICATION_P12_PASSWORD }}

  # Variables d'environnement pour le déploiement sur OVH S3, utilisées pour l'étape de déploiement avec AWS CLI (sync)
  # Même si c'est écrit "AWS_", ce sont en réalité les identifiants d'accès pour le bucket OVH S3, car OVH S3 est compatible avec l'API AWS S3
  AWS_ACCESS_KEY_ID: ${{ secrets.AETHERROYALE_S3_BUCKET_OVH_ACCESS_KEY_ID }}
  AWS_SECRET_ACCESS_KEY: ${{ secrets.AETHERROYALE_S3_BUCKET_OVH_SECRET_ACCESS_KEY }}
  AWS_DEFAULT_REGION: ${{ secrets.AETHERROYALE_S3_BUCKET_OVH_REGION }}
  OVH_S3_ENDPOINT: ${{ secrets.AETHERROYALE_S3_BUCKET_OVH_ENDPOINT }}
  OVH_S3_BUCKET: ${{ secrets.AETHERROYALE_S3_BUCKET_OVH_NAME }}

jobs:
  build_game_and_sign:
    strategy:
      fail-fast: false
      matrix:
        config:
        - { runner: ubuntu-latest,    platform: steamrt4, arch: x64, container: "registry.gitlab.steamos.cloud/steamrt/steamrt4/sdk:4.0.20260119.200228" }
        - { runner: ubuntu-24.04-arm, platform: steamrt4, arch: arm64,  container: "registry.gitlab.steamos.cloud/steamrt/steamrt4/sdk/arm64:4.0.20260119.200228" }
        - { runner: windows-2025,     platform: windows,  arch: x64 }
        - { runner: windows-11-arm,   platform: windows,  arch: arm64 }
        - { runner: ubuntu-22.04,     platform: linux,    arch: x64 }
        - { runner: ubuntu-22.04-arm, platform: linux,    arch: arm64 }
        - { runner: ubuntu-latest,    platform: android,  arch: "armeabi-v7a,arm64-v8a" }
        - { runner: macos-26,         platform: macos,    arch: arm64, sdk: macosx } 
        - { runner: macos-26,         platform: ios,      arch: arm64, sdk: iphoneos }
    name: ${{ matrix.config.platform }}-${{ matrix.config.arch }}-${{ matrix.config.sdk }}
    runs-on: ${{ matrix.config.runner }}
    container: ${{ matrix.config.platform == 'steamrt4' && matrix.config.container || '' }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Get dependencies with CMake - All platforms
        run: cmake -P cmake/setup_dependencies.cmake

      - name: Read current version from version.txt and append branch and commit hash - Windows
        if: matrix.config.platform == 'windows'
        run: |
          VERSION_BASE=$(cat version.txt)
          
          # Check if VERSION_BASE is empty and set default value if necessary
          if [ -z "$VERSION_BASE" ]; then
            VERSION_BASE="1.0.0"
          fi
          
          echo "APP_VERSION=$VERSION_BASE" >> $GITHUB_ENV
        shell: bash

      - name: Read current version from version.txt and append branch and commit hash - Linux / Android / SteamRT4 / macOS / iOS
        if: matrix.config.platform != 'windows'
        run: |
          VERSION_BASE=$(cat version.txt)
          
          # Check if VERSION_BASE is empty and set default value if necessary
          if [ -z "$VERSION_BASE" ]; then
            VERSION_BASE="1.0.0"
          fi
          
          echo "APP_VERSION=$VERSION_BASE" >> $GITHUB_ENV
          
      - name: Set variables environment for versionCode and versionName - Android
        if: matrix.config.platform == 'android'
        run: |
          # Génère le versionCode en divisant le timestamp UNIX par 100 pour avoir un nombre plus petit
          # Ne doit pas dépasser 2100000000 (versionCode max pour Android)
          # Cela signifie que vous pourriez techniquement produire un nouveau build toutes les 1 minute et 40 secondes 
          # sans que deux builds consécutifs n'aient le même versionCode.
          TIMESTAMP=$(date +%s)
          VERSION_CODE=$(($TIMESTAMP / 100))
          echo "ANDROID_VERSION_CODE=$VERSION_CODE" >> $GITHUB_ENV 
          echo "ANDROID_VERSION_NAME=$APP_VERSION" >> $GITHUB_ENV

      - name: Set variables environment for CFBundleShortVersionString and CFBundleVersion - macOS / iOS
        if: matrix.config.platform == 'macos' || matrix.config.platform == 'ios'
        run: |
          # Génère le CFBundleVersion en utilisant le timestamp UNIX pour avoir un nombre toujours croissant
          TIMESTAMP=$(date +%s)
          echo "APP_IOSMACOS_BUILD_VERSION=$TIMESTAMP" >> $GITHUB_ENV

      - name: Save version in variables.env - Linux x64 (for Windows / Linux / Android / SteamRT4)
        # On execute cette étape que sur 1 Linux parce que c'est la même version pour Windows, Linux, Android et SteamRT4
        if: matrix.config.platform == 'linux' && matrix.config.arch == 'x64'
        run: |
          echo "APP_VERSION=$APP_VERSION" > variables.env

      - name: Upload version in Artifacts - Linux x64 (for Windows / Linux / Android / SteamRT4)
        # On execute cette étape que sur 1 Linux parce que c'est la même version pour Windows, Linux, Android et SteamRT4
        if: matrix.config.platform == 'linux' && matrix.config.arch == 'x64'
        uses: actions/upload-artifact@v6
        with:
          name: variables
          path: variables.env

      - name: Save version and identifier in variables-apple.env - macOS / iOS
        # On execute cette étape que sur macOS parce que c'est la même version pour macOS et iOS
        if: matrix.config.platform == 'macos'
        run: |
          echo "APP_VERSION=$APP_VERSION" > variables-apple.env
          echo "APP_IOSMACOS_IDENTIFIER=$APP_IOSMACOS_IDENTIFIER" >> variables-apple.env

      - name: Upload version and identifier in Artifacts - macOS / iOS
        # On execute cette étape que sur macOS parce que c'est la même version pour macOS et iOS
        if: matrix.config.platform == 'macos'
        uses: actions/upload-artifact@v6
        with:
          name: variables-apple
          path: variables-apple.env

      - name: Print the version of the app - All platforms
        run: echo "The final app version is $APP_VERSION"

      - name: Install dependencies for AppImage - Linux
        if: matrix.config.platform == 'linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libfuse2

      - name: Install patchelf - Linux / SteamRT4
        if: matrix.config.platform == 'linux' || matrix.config.platform == 'steamrt4'
        run: |
          sudo apt-get update
          sudo apt-get install -y patchelf

      - name: Install dev dependencies (for SDL3) - Linux / SteamRT4
        if: matrix.config.platform == 'linux' || matrix.config.platform == 'steamrt4'
        run: |
          sudo apt-get update
          sudo apt-get -y install build-essential git make \
          pkg-config cmake ninja-build gnome-desktop-testing libasound2-dev libpulse-dev \
          libaudio-dev libfribidi-dev libjack-dev libsndio-dev libx11-dev libxext-dev \
          libxrandr-dev libxcursor-dev libxfixes-dev libxi-dev libxss-dev libxtst-dev \
          libxkbcommon-dev libdrm-dev libgbm-dev libgl1-mesa-dev libgles2-mesa-dev \
          libegl1-mesa-dev libdbus-1-dev libibus-1.0-dev libudev-dev libthai-dev \
          libpipewire-0.3-dev libwayland-dev libdecor-0-dev liburing-dev
          
      - name: Setup Java JDK LTS - Android
        if: matrix.config.platform == 'android'
        uses: actions/setup-java@v5
        with:
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          java-version: ${{ env.JAVA_VERSION }}

      - name: Setup Android SDK (Platform + Build Tools + NDK + CMake + CLI) - Android
        if: matrix.config.platform == 'android'
        uses: android-actions/setup-android@v3
        with:
          accept-android-sdk-licenses: true
          packages: >
            platform-tools
            platforms;${{ env.ANDROID_PLATFORM_VERSION }}
            build-tools;${{ env.ANDROID_BUILD_TOOLS_VERSION }}
            ndk;${{ env.ANDROID_NDK_VERSION }}
            cmake;${{ env.ANDROID_CMAKE_VERSION }}
            cmdline-tools;${{ env.ANDROID_CMDLINE_TOOLS_VERSION }}
          
      - name: Decode Keystore and create file .keystore for Sign APK/AAB after - Android
        if: matrix.config.platform == 'android'
        run: echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 --decode > my-release-key.keystore

      - name: Generate APK / AAB and Sign - Android
        if: matrix.config.platform == 'android'
        run: |
          chmod +x ./gradlew
          ./gradlew assembleRelease
          ./gradlew bundleRelease
        working-directory: android-project
        env:
          ANDROID_VERSION_CODE: ${{ env.ANDROID_VERSION_CODE }}
          ANDROID_VERSION_NAME: ${{ env.ANDROID_VERSION_NAME }}

      - name: Organize the build for Artificats - Android
        if: matrix.config.platform == 'android'
        run: |
          mkdir -p android/apk/
          mkdir -p android/aab/
          mv android-project/app/build/outputs/apk/release/app-release.apk android/apk/
          mv android-project/app/build/outputs/bundle/release/app-release.aab android/aab/
          
      - name: Install the Apple Certificate and Provisioning Profile (Apple Distribution) - AppStore / TestFlight - iOS
        if: matrix.config.platform == 'ios'
        run: |
          # create variables
          CERTIFICATE_PATH=$RUNNER_TEMP/build_certificate.p12
          PP_PATH=$RUNNER_TEMP/build_pp.mobileprovision
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db

          # import certificate and provisioning profile from secrets
          echo -n "$IOSMACOS_APPLE_CERTIFICATE_APPLEDISTRIBUTION_P12_BASE64" | base64 --decode -o $CERTIFICATE_PATH
          echo -n "$IOSMACOS_APPLE_PROVISIONING_PROFILE_APPLEDISTRIBUTION_BASE64" | base64 --decode -o $PP_PATH

          # create temporary keychain
          security create-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH

          # import certificate to keychain
          security import $CERTIFICATE_PATH -P "$IOSMACOS_APPLE_CERTIFICATE_APPLEDISTRIBUTION_P12_PASSWORD" -A -t cert -f pkcs12 -k $KEYCHAIN_PATH
          security set-key-partition-list -S apple-tool:,apple: -k "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security list-keychain -d user -s $KEYCHAIN_PATH

          # apply provisioning profile
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          cp $PP_PATH ~/Library/MobileDevice/Provisioning\ Profiles

      - name: Install the Apple Certificate (Developer ID Application) - Not Mac AppStore - macOS
        if: matrix.config.platform == 'macos'
        run: |
          # create variables
          CERTIFICATE_PATH=$RUNNER_TEMP/build_certificate.p12
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db

          # import certificate
          echo -n "$MACOS_APPLE_CERTIFICATE_DEVELOPERIDAPPLICATION_P12_BASE64" | base64 --decode -o $CERTIFICATE_PATH

          # create temporary keychain
          security create-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH

          # import certificate to keychain
          security import $CERTIFICATE_PATH -P "$MACOS_APPLE_CERTIFICATE_DEVELOPERIDAPPLICATION_P12_PASSWORD" -A -t cert -f pkcs12 -k $KEYCHAIN_PATH
          security set-key-partition-list -S apple-tool:,apple: -k "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security list-keychain -d user -s $KEYCHAIN_PATH

      - name: Setup Xcode and Setup Command Line Tools - macOS / iOS
        if: matrix.config.platform == 'ios' || matrix.config.platform == 'macos'
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ env.XCODE_VERSION }}

      - name: Determine SDK Path and set SDKROOT - macOS / iOS
        if: matrix.config.platform == 'macos' || matrix.config.platform == 'ios'
        run: |
          sdk="${{ matrix.config.sdk }}"
          SDKROOT=$(xcrun --sdk "$sdk" --show-sdk-path)
          SDKVERSION=$(xcrun --sdk "$sdk" --show-sdk-version)
          echo "SDKROOT=$SDKROOT" >> $GITHUB_ENV
          echo "Using SDK: $sdk"
          echo "SDK Path: $SDKROOT"
          echo "SDK Version: $SDKVERSION"
        shell: bash

      - name: Configure project with CMake and Run build - iOS (iphoneos)
        if: matrix.config.platform == 'ios'
        uses: threeal/cmake-action@v2.1.0
        with:
          build-dir: build-${{ matrix.config.platform }}-${{ matrix.config.arch }}
          generator: Xcode
          options: CMAKE_SYSTEM_NAME=iOS

      - name: Run build with CMake - iOS (iphoneos)
        if: matrix.config.platform == 'ios'
        run: cmake --build build-${{ matrix.config.platform }}-${{ matrix.config.arch }} --config Release

      - name: Verify the signature - iOS (iphoneos)
        if: matrix.config.platform == 'ios'
        run: codesign --verify --deep --verify --verbose=4 build-${{ matrix.config.platform }}-${{ matrix.config.arch }}/Release/*.app

      - name: Create .ipa package for AppStore - iOS (iphoneos)
        if: matrix.config.platform == 'ios'
        run: |
          # Create Payload directory and move .app into it
          mkdir Payload
          cp -a build-${{ matrix.config.platform }}-${{ matrix.config.arch }}/Release/*.app Payload/
 
          # Recuperer le nom du fichier .app pour avoir le même nom pour le .ipa, puis zip le Payload dans un .ipa
          APP_NAME=$(basename Payload/*.app .app)
          zip -ry $APP_NAME.ipa Payload/

          # Move .ipa to build directory
          mv $APP_NAME.ipa build-${{ matrix.config.platform }}-${{ matrix.config.arch }}/Release/

      - name: Validate app with altool - iOS (iphoneos)
        if: matrix.config.platform == 'ios'
        run: |
          xcrun altool --validate-app --file build-${{ matrix.config.platform }}-${{ matrix.config.arch }}/Release/*.ipa --type ios --username ${{ env.APPLE_ID }} --password ${{ env.APPLE_APPLICATION_SPECIFIC_PASSWORD }}

      - name: Configure project with CMake - Windows (x64/arm64)
        if: matrix.config.platform == 'windows'
        uses: threeal/cmake-action@v2.1.0
        with:
          build-dir: build-${{ matrix.config.platform }}-${{ matrix.config.arch }}
          generator: Visual Studio 17 2022
          options: RC2D_ARCH=${{ matrix.config.arch }}
          c-compiler: cl
          cxx-compiler: cl
          args: -A ${{ matrix.config.arch }}

      - name: Run build with CMake - Windows (x64/arm64)
        if: matrix.config.platform == 'windows'
        run: cmake --build build-${{ matrix.config.platform }}-${{ matrix.config.arch }} --config Release

      # TODO: Il faut racheter un certificat de signature de code pour pouvoir signer les builds Windows (x64 et arm64) avec AzureSignTool
      #- name: Sign files with AzureSignTool - Windows (x64/arm64)
      #  if: matrix.config.platform == 'windows'
      #  uses: CrzGames/azure-signtool-action@v1.1.0
      #  with:
      #    azure-key-vault-url: 'https://signmycodecertificates.vault.azure.net'
      #    azure-key-vault-client-id: ${{ secrets.AZURE_KEY_VAULT_APP_CLIENT_ID }}
      #    azure-key-vault-client-secret: ${{ secrets.AZURE_KEY_VAULT_APP_CLIENT_SECRET }}
      #    azure-key-vault-tenant-id: ${{ secrets.AZURE_KEY_VAULT_TENANT_ID }}
      #    azure-key-vault-certificate: 'CorentinRecanzone'
      #    timestamp-rfc3161: 'http://timestamp.digicert.com'
      #    timestamp-digest: 'sha512'
      #    file-digest: 'sha512'
      #    files: 'build-${{ matrix.config.platform }}-${{ matrix.config.arch }}/Release/*.dll build-${{ matrix.config.platform }}-${{ matrix.config.arch }}/Release/*.exe'
      #    recursive: true

      - name: Configure project with CMake and Run build - Linux (x64/arm64)
        if: matrix.config.platform == 'linux'
        uses: threeal/cmake-action@v2.1.0
        with:
          run-build: true
          build-dir: build-${{ matrix.config.platform }}-${{ matrix.config.arch }}
          generator: Unix Makefiles
          c-compiler: gcc
          cxx-compiler: g++
          options: CMAKE_BUILD_TYPE=Release RC2D_ARCH=${{ matrix.config.arch }}

      - name: CMake Install for generate AppImage - Linux
        if: matrix.config.platform == 'linux'
        run: cmake --install build-${{ matrix.config.platform }}-${{ matrix.config.arch }}
        
      - name: Configure project with CMake - macOS
        if: matrix.config.platform == 'macos'
        uses: threeal/cmake-action@v2.1.0
        with:
          build-dir: build-${{ matrix.config.platform }}-${{ matrix.config.arch }}
          generator: Xcode
          c-compiler: clang
          cxx-compiler: clang++
          options: CMAKE_SYSTEM_NAME=Darwin
          # A voir si on supprime ou pas : CMAKE_XCODE_ATTRIBUTE_CODE_SIGN_INJECT_BASE_ENTITLEMENTS=NO
          
      - name: Run build with CMake - macOS
        if: matrix.config.platform == 'macos'
        run: cmake --build build-${{ matrix.config.platform }}-${{ matrix.config.arch }} --config Release

      - name: Verify the signature - macOS
        if: matrix.config.platform == 'macos'
        run: codesign --verify --deep --verify --verbose=4 build-${{ matrix.config.platform }}-${{ matrix.config.arch }}/Release/*.app
        
      - name: Store credentials for notarization - macOS
        if: matrix.config.platform == 'macos'
        run: |
          xcrun notarytool store-credentials login \
          --apple-id "${{ env.APPLE_ID }}" \
          --team-id "${{ env.APPLE_TEAM_ID }}" \
          --password "${{ env.APPLE_APPLICATION_SPECIFIC_PASSWORD }}"

      - name: Create zip for notarization - macOS
        if: matrix.config.platform == 'macos'
        run: zip -r --symlinks build-${{ matrix.config.platform }}-${{ matrix.config.arch }}/Release/MyApp.zip build-${{ matrix.config.platform }}-${{ matrix.config.arch }}/Release/*.app

      - name: Submit app for notarization - macOS
        if: matrix.config.platform == 'macos'
        run: xcrun notarytool submit build-${{ matrix.config.platform }}-${{ matrix.config.arch }}/Release/MyApp.zip --wait --keychain-profile login

      - name: Staple the notarization ticket - macOS
        if: matrix.config.platform == 'macos'
        run: xcrun stapler staple build-${{ matrix.config.platform }}-${{ matrix.config.arch }}/Release/*.app

      - name: Verify the signature and notarization - macOS
        if: matrix.config.platform == 'macos'
        run: spctl --assess --verbose=2 --type exec build-${{ matrix.config.platform }}-${{ matrix.config.arch }}/Release/*.app
        
      - name: Zip the bundle .app for Artificat - macOS
        if: matrix.config.platform == 'macos'
        # OBLIGATOIRE de faire ça sinon quand ont l'envoie dans les artifacts sans le zip avec le flag --symlinks
        # GitHub Actions ne prend pas en compte les symlinks et le .app ne fonctionne pas (error is ambiguous)
        run: |
          # Recuperer le nom du fichier .app pour avoir le même nom pour le .zip
          APP_NAME=$(basename build-${{ matrix.config.platform }}-${{ matrix.config.arch }}/Release/*.app .app)
          # Supprimer l'ancien zip
          rm -f build-${{ matrix.config.platform }}-${{ matrix.config.arch }}/Release/*.zip
          # Créer un dossier macos et copier le .app dedans
          mkdir macos
          cp -a build-${{ matrix.config.platform }}-${{ matrix.config.arch }}/Release/*.app macos/
          # Zip le bundle .app
          zip -r --symlinks macos/$APP_NAME.zip macos/*.app
          # Supprimer le bundle .app
          rm -rf macos/*.app

      - name: Archive executable artifacts - Android
        if: matrix.config.platform == 'android'
        uses: actions/upload-artifact@v6
        with:
          name: ${{ matrix.config.platform }}
          retention-days: 1
          path: android

      - name: Archive executable artifacts - iOS
        if: matrix.config.platform == 'ios'
        uses: actions/upload-artifact@v6
        with:
          name: ${{ matrix.config.platform }}-${{ matrix.config.arch }}
          retention-days: 1
          path: |
            build-${{ matrix.config.platform }}-${{ matrix.config.arch }}/Release/*.ipa

      - name: Archive executable artifacts - macOS
        if: matrix.config.platform == 'macos'
        uses: actions/upload-artifact@v6
        with:
          name: ${{ matrix.config.platform }}-${{ matrix.config.arch }}
          retention-days: 1
          path: macos/*.zip

      - name: Archive executable artifacts - Linux
        if: matrix.config.platform == 'linux'
        uses: actions/upload-artifact@v6
        with:
          name: ${{ matrix.config.platform }}-${{ matrix.config.arch }}
          retention-days: 1
          path: |
            build-${{ matrix.config.platform }}-${{ matrix.config.arch }}/Release/*.AppImage

      - name: Archive executable artifacts - Windows
        if: matrix.config.platform == 'windows'
        uses: actions/upload-artifact@v6
        with:
          name: ${{ matrix.config.platform }}-${{ matrix.config.arch }}
          retention-days: 1
          path: |
            build-${{ matrix.config.platform }}-${{ matrix.config.arch }}/Release/*

  deploy_executable_platform:
    needs: build_game_and_sign
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: ubuntu-latest
          - platform: macos-26
    runs-on: ${{ matrix.platform }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Download all artifacts
        uses: actions/download-artifact@v7

      #- name: Read version from artifact variables.env - Windows / Linux / Android / SteamRT4
      #  # On'as besoin de la version pour l'étape de déploiement via Minio
      #  if: matrix.platform == 'ubuntu-latest'
      #  run: |
      #    source variables/variables.env
      #    echo "APP_VERSION=$APP_VERSION" >> $GITHUB_ENV

      #- name: Read version and identifier from artifact variables-apple.env - iOS (iphoneos)
      #  # On'as besoin de ces variables pour l'étape de fastlane via le script Fastfile
      #  if: matrix.platform == 'macos-26'
      #  run: |
      #    source variables-apple/variables-apple.env
      #    echo "APP_VERSION=$APP_VERSION" >> $GITHUB_ENV
      #    echo "APP_IOSMACOS_IDENTIFIER=$APP_IOSMACOS_IDENTIFIER" >> $GITHUB_ENV

      #- name: Install Fastlane via Homebrew - iOS (iphoneos)
      #  if: matrix.platform == 'macos-26'
      #  run: brew install fastlane

      # Bien que cette erreur apparaisse dans les logs de CI, les builds sont en réalité correctement distribués aux groupes internes et externes sur App Store Connect.
      # Nous attendons un correctif de la part de l'équipe Fastlane. En attendant, nous continuerons à surveiller manuellement les distributions de builds.
      #- name: Deploy IPA to TestFlight (groups beta/qa) - iOS (iphoneos)
      #  if: matrix.platform == 'macos-26'
      #  run: |
      #    mv ios-arm64-arm64e/*.ipa platforms/ios/
      #    IPA_PATH=$(ls platforms/ios/*.ipa | head -n 1)
      #    if [ -z "$IPA_PATH" ]; then
      #      echo "No IPA file found in platforms/ios/"
      #      exit 1
      #    fi
      #    
      #    cd platforms/ios
      #    fastlane submit_for_review to_testflight:true
          
      #- name: Deploy AAB to Play Store (tests internes) - Android
      #  if: matrix.platform == 'ubuntu-latest'
      #  uses: r0adkll/upload-google-play@v1
      #  with:
      #    serviceAccountJsonPlainText: ${{ secrets.ANDROID_GOOGLE_CLOUD_PLATEFORM_SERVICE_JSON }}
      #    packageName: "com.crzgames.testexe"
      #    whatsNewDirectory: "android-project/distribution/whatsnew"
      #    status: "completed" # Or completed/inProgress/halted/draft
      #    releaseFiles: "android/aab/*.aab"
      #    # Doc (track) : https://developers.google.com/android-publisher/tracks?hl=fr#adding_and_modifying_apks
      #    # Production : production
      #    # Tests ouverts : beta
      #    # Tests internes : qa
      #    track: "qa" # Or beta/qa/production

      #- name: Deploy AAB to Play Store (tests ouverts) - Android
      #  if: matrix.platform == 'ubuntu-latest'
      #  uses: r0adkll/upload-google-play@v1
      #  with:
      #    serviceAccountJsonPlainText: ${{ secrets.ANDROID_GOOGLE_CLOUD_PLATEFORM_SERVICE_JSON }}
      #    packageName: "com.crzgames.testexe"
      #    whatsNewDirectory: "android-project/distribution/whatsnew"
      #    status: "completed" # Or completed/inProgress/halted/draft
      #    releaseFiles: "android/aab/*.aab"
      #    # Doc (track) : https://developers.google.com/android-publisher/tracks?hl=fr#adding_and_modifying_apks
      #    # Production : production
      #    # Tests ouverts : beta
      #    # Tests internes : qa
      #    track: "beta" # Or beta/qa/production

      - name: Organize Artificats for Windows / Linux / Android / SteamRT4 / macOS / iOS
        if: matrix.platform == 'ubuntu-latest'
        run: |
          mkdir -p windows/x64
          mkdir -p windows/arm64
          mkdir -p linux/x64
          mkdir -p linux/arm64
          mkdir -p android/armeabi-v7a
          mkdir -p android/arm64-v8a
          mkdir -p macos/arm64
          mv windows-x64/*.exe windows/x64/
          mv windows-x64/*.dll windows/x64/
          mv windows-arm64/*.exe windows/arm64/
          mv windows-arm64/*.dll windows/arm64/
          mv linux-x64/*.AppImage linux/x64/
          mv linux-arm64/*.AppImage linux/arm64/
          mv android-armeabi-v7a/*.apk android/armeabi-v7a/
          mv android-arm64-v8a/*.apk android/arm64-v8a/
          mv macos-arm64/*.zip macos/arm64/

      - name: Install AWS CLI for deploy on OVH S3
        if: matrix.platform == 'ubuntu-latest'
        run: |
          python -m pip install --upgrade pip
          pip install awscli

      # Deploie sur un bucket S3 les fichiers du jeu
      # Pour chaque plateforme Desktop (Windows, Linux, macOS, SteamRT4)
      - name: Upload artifacts (Game) to OVH S3
        if: matrix.platform == 'ubuntu-latest'
        run: |
          set -euo pipefail

          # IMPORTANT:
          # - garde --delete si tu veux un miroir exact (comme ton action MinIO)
          # - enlève --delete si tu veux conserver d’anciennes versions/fichiers
          SYNC_FLAGS="--delete"

          aws --endpoint-url "$OVH_S3_ENDPOINT" s3 sync \
            "windows/x64/" "s3://$OVH_S3_BUCKET/games/binaries/game-testexe/windows/x86_64/$APP_VERSION/" \
            $SYNC_FLAGS

          aws --endpoint-url "$OVH_S3_ENDPOINT" s3 sync \
            "windows/x86/" "s3://$OVH_S3_BUCKET/games/binaries/game-testexe/windows/x86/$APP_VERSION/" \
            $SYNC_FLAGS

          aws --endpoint-url "$OVH_S3_ENDPOINT" s3 sync \
            "macos/" "s3://$OVH_S3_BUCKET/games/binaries/game-testexe/macos/x86_64-arm64/$APP_VERSION/" \
            $SYNC_FLAGS

          aws --endpoint-url "$OVH_S3_ENDPOINT" s3 sync \
            "linux/" "s3://$OVH_S3_BUCKET/games/binaries/game-testexe/linux/x86_64/$APP_VERSION/" \
            $SYNC_FLAGS